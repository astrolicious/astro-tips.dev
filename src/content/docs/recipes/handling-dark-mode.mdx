---
title: Handling dark mode
---

import { Tabs, TabItem, Steps } from "@astrojs/starlight/components";

Adding dark mode support to improve the user experience is now a common need on the web. And surprisingly, it can proved difficult to get it right using Astro. Let's see how to do it the right way!

## Solution

<Steps>

1. To Avoid FOUC, we need to load the script in the layout file, the `is:inline` attribute in the script tag.

    ```html {4} "is:inline"
    <html>
        <head>
            <script is:inline>
                // The recipe script here
            </script>
            <!-- load it earlier then, other scripts to avoid Flash of Content -->
        </head>
    </html>
    ```

2. Getting the current theme from local storage or system preference

    ```ts
    /** @type {'dark'|'light'|'auto'} */
    let theme = localStorage.getItem('theme') ??
        window.matchMedia('(prefers-color-scheme: dark)').matches 
            ? 'dark' 
            : 'light'
    ```

3. Define a function to store the theme value in local storage

    ```ts
    /**
    * @param {'dark'|'light'|'auto'} theme
    */
    const setTheme = (_theme = 'auto') => {
        theme = _theme;
        localStorage.setItem('theme', theme);
    }
    ```

4. if the theme is "dark", add the "dark" class to the `html` element, else remove the "dark" class from `html` element

    ```ts
    /**
    * @param {'dark'|'light'|'auto'} theme
    */
    const setTheme = (_theme = 'auto') => {
        theme = _theme;
        localStorage.setItem('theme', theme);
        if (theme === 'dark') 
            document.documentElement.classList.add('dark');
        else if (theme === 'light')
            document.documentElement.classList.remove('dark');
        else {
            if(window.matchMedia('(prefers-color-scheme: dark)').matches)
                document.documentElement.classList.add('dark');
            else 
                document.documentElement.classList.remove('dark');
        }
    }
    ```

5. Create button tag with `#theme-toggle` **id** to toggle the theme!

    ```html
    <button id="theme-toggle">Toggle Theme</button>
    ```

6. Listening for Click Event on the button with `#theme-toggle` **id** to toggle the theme
    <Tabs>
        <TabItem label="MPA">
            ```ts
            const options = ['dark', 'light', 'auto'];
            setTheme(theme)
            window.onload = () => {
                document.querySelector('#theme-toggle')
                    ?.addEventListener('click', () => {
                    // rotate through options
                    setTheme(options[(options.indexOf(theme) + 1) % options.length]);
                });
            };
            ```
        </TabItem>
        <TabItem label="VT">
            ```ts
            const options = ['dark', 'light', 'auto'];
            setTheme(theme)
            document.addEventListener('astro:page-load', () => {
                document.querySelector('#theme-toggle')
                    ?.addEventListener('click', () => {
                    // rotate through options
                    setTheme(options[(options.indexOf(theme) + 1) % options.length]);
                });
            });
            ```
        </TabItem>
    </Tabs>

7. Listening for System Changes    

    ```ts
    window.matchMedia('(prefers-color-scheme: dark)')
        .addEventListener('change', ({ matches: isDark }) => {
            setTheme(isDark ? 'dark' : 'light')
        })
    ```
</Steps>

## Full Code

```ts title="src/components/theme-toggle/script.js"
/** @type {'dark'|'light'|'auto'} */
let theme = ('theme' in localstorage) 
    ? localStorage.theme 
    : window.matchMedia('(prefers-color-scheme: dark)').matches 
        ? 'dark' 
        : 'light';

/**
* @param {'dark'|'light'|'auto'} theme
*/
const setTheme = (_theme = 'auto') => {
    theme = _theme;
    localStorage.setItem('theme', theme);
    if (theme === 'dark') 
        document.documentElement.classList.add('dark');
    else if (theme === 'light')
        document.documentElement.classList.remove('dark');
    else {
        if(window.matchMedia('(prefers-color-scheme: dark)').matches)
            document.documentElement.classList.add('dark');
        else 
            document.documentElement.classList.remove('dark');
    }
}
// If you don't support auto, just change this option to
// ['dark','light'] it will still work
const options = ['dark', 'light', 'auto'];
// initial theme, based on the last user preferences otherwise, based on system
setTheme(theme)

document.addEventListener('astro:page-load', () => {
    document.querySelector('#theme-toggle')
    ?.addEventListener('click', () => {
        // rotate through options
        setTheme(options[(options.indexOf(theme) + 1) % options.length]);
    });
});

window.matchMedia('(prefers-color-scheme: dark)')
    .addEventListener('change', ({ matches: isDark }) => {
        setTheme(isDark ? 'dark' : 'light')
    })
```